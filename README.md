<img src="http://students.uni-sofia.bg/wp/wp-content/uploads/2010/11/logo-su-s-nadpis.jpg"/>

# Система за автоматизирано подпомагане и проверка

## Цел

Целта на дипломната работа е създаване на Continious Integration система за автоматизирано подпомагане на обучението в курсовете по програмиране в Софийски университет "Св. Климент Охридски"

## Билдване

За билдването на системата се изпозлва билд тула Gradle. Gradle осигурява иновативен начин [wrapper](http://gradle.org/docs/current/userguide/gradle_wrapper.html) , който позволява да се работи с Gradle билдове без да е необходима ръчна инсталация. Wrapper е batch скрипт за Windows и shell скрипт за другите операционни системи.

Желателно е да се изпозлва wrapper за билдване на Gradle базирани проекти. Като цяло използването му гарантира, че за билда ще се използва тази версия на Gradle, която е необходима.

### Конфигуриране 

Системата дава лесна възмонжост за избиране на конфигурационене файл, чрез който да се настроят необходимите характеристики на проекта.

<img src="http://195.149.248.189:8080/2014-03-12/3b799fcee24b2c4dd348d66eaa30164d_245x114.jpg" width="245px" height="114px" class="inlinePic"/>

#####Именуване
Тези конфигурационни файлове <име>.gradle са Gradle билд скриптове и за тях важат всички правила, които се отнасят за другите скритове.  Желателно е <име> да е името на курса, чийто конфигуриране ще искаме да извършим.
Тези скриптове трябва да се създадат предварително от потребителя и трябва да бъдат поставени в

    Project/config/specifications

#####Стартиране
За да бъдат изпозлвани при стартиране на билд, името на желания скрипт трябва да се подаде като __system property__
Това може да бъде извършено чрез 

    ./gradlew -Pconf=example command1 command2

__conf__ е името на системната променлива, а example е името на скриптовия файл описан в [Именуване](#Именуване).
```text
    Ако не специфицирате стойност на системната променлива conf ще бъде взет default.gradle скрипта
```


## Плъгини
Системата позволява да бъдат създадени собствени плъгини. Те разширяват възможностите на системата и позволяват една функционалност
( тази описана в плъгина) да бъде използвана на много различни места. Плъгините на системата не са разработени като отделни външни артефакти, 
т.е. те може да бъдат използвани само в конкретния проект.
### Същност
Плъгинът е разширение на Gradle, което конфигурира проекта по някакъв начин, обикновенно това става чрез добавяне на преварително 
конфигурирани таскове (задачи), които заедно извършват някаква работа. Gradle се дистрибутира с определен набор от плъгини, 
които лесно могат да бъдат разширени( extend-нати) или да бъдат създадени нови такива). 
В системата те се намират в директорията __buildSrc__, това е така поради особеността на изпълнение на билда в _Gradle_.
Преди да започне самото резолване на дипендъситата и билдване на сорскода от __src__ директорията например, се извършва 
билдване на съдържанието на __buildSrc__ директорията, т.е. преди започване на същинското билдване плъгините, които ние 
сме създали са билднати успешно и са достъпни за нашия код.
 
### Структура на buildSrc 
Директорията __buildSrc__ представлява сама по себе си многомодулен проект. Тя се състои от специално създадените разширения, които
са създадени за целите на различните предмети, в които ще се използват. Те са разположени в __plugins__. Освен това в тази директория 
са разположени и други плъгини, които имат помощни функции за системата, т.е. са създадени да подпомагат нейните функции,
а не са специално направени за извършване на проверки или оценки по даден предмет. Разбира се те може да се използват и композират 
в разширения, които да се ползват от преподавателите.
За да бъде създадено ново разширение, то трябва да се спазват [Gradle конвенциите](http://www.gradle.org/docs/current/userguide/custom_plugins.html) и препоръките за неговото разработване.
 
  
###Налични Плъгини
__FMIJavaPlugin__ разширява вградения __JavaPlugin__, като добавя няколко таска свързани с разархивиране, изтриване на проектни артефакти. Освен това той включва всички таскове на своя предшественик - таскове за компилиране, изпълнение на unit тестове и билдване на __Jar__ файлове.

__FMIJavaPlugin__ е базиран на конвенции. Това означава,че в много от случаите плъгина задава стойности по подразбиране на повечето свойства на проекта, като например директрояита, в която ще бъдат разархивиране проектните артефакти. Ако се спазват тези конвенции от потребителя не се изисква много работа за извършване на конфигурация на плъгина. Но от друга страна се дава възможност и за тяхното конфигуриране спрямо нуждите на потребителя.

За да използвате __FMIJavaPlugin__ във вашия билд:

__oop.gradle__

	apply plugin: 'fmi-java'

#### Типове таскове
Плъгинът предоставя няколко типа таск. Един от тях е __getInfo__, който позволява да се извърши извличане на необходимте файлове( проектни архиви, които трябва да се проверяват), тяхното разпактериране, както и създаване на нов [sourceSet](#http://www.gradle.org/docs/current/userguide/java_plugin.html#N11E60) за всеки отделен проект. 
За да можете да използвате таска __getInfo__ трябва да конифурирате задължителните му свойства:

__свойства:__

__courseName__ (Опционално)Името на курса, за който ще се отнася този таск. Това свойство е опционално, ако се изтърве за име на курс се взима стойността на системното свойство __conf__

__outputDir__ (Опционално) директорията, в която ще се разархивират файловете. Това свойство е опционално, ако се изтърве за изходна директория на сор кода се взима __src__директорията и там те се разархивират.

__sourceFiles__(Задължително) Колекция от файлове, директории, в които са поместени различните файлове, които ще се разархивират и проверяват.

__oop.gradle__

	apply plugin: 'fmi-java'

	getInfo {
		courseName = "OOP_Java"
		sourceFiles = files(/C:\main\resources/)
		outputDir= "bin"
	}

След това можете да изпозлвате 

    ./gradlew -Pconf=oop getInfo

Освен него плъгинът разполага и със задачата uploadDropbox, който извършва качване на посочени файлове в определен DropBox акаунт.

__свойства:__

__authFile__ (Задължително) Пътя до файла, в който се намира __token__ за DropBox акаунта, в който ще се качват файа

__localFilesToUpload__ (Задължително) Пътят до файла или файловете, които ще се качват

Всеки файл, който се качва се upload-ва в уникална директория във формат 'yyyy-MM-dd-kk-mm-ss'

__Важно__
Тъй като _токена_ позволява обмяна на файлове към Dropbox акаунт без да е необходима друга аутентикация е препоръчително той
да се съхранява на сигурно място. Поради тази причина е добре да се създаде променлива, която да се добави в 

	userhome/.gradle/gradle.properties 
	
И после да се конфигурира посредством изпозлване на името на променливата, чрез ограничаване на достъпа до __gradle.properties__ файла
на машината, върху която се извършват билдовете ще се позволи да се използва дадения __token__ ,но само в рамките на системата,
без право да се вижда, променя или копира. За повече информация [тук](http://www.gradle.org/docs/current/userguide/tutorial_this_and_that.html)

	uploadDropbox {
		authFile = TOKEN
		localFilesToUpload "${project.buildDir}\\reports"
	}

Където TOKEN е име на свойство дефинирано в properties файл, а __localFilesToUpload__ посочва, че директорията reports трябва да се качи

__deleteSrc__ е името на друга задача, която плъгина предоставя. Тя изтрива всички изходни файлове от getInfo задачата.

__sendEmail__ е таска, който позволява изпращане на email съобщения.

__свойства__:

__message__ (Опционално) Съдържание на съобщението

__subject__ (Задължително) Заглавие на съобщението

__toAddress__ (Задължително) Единичен адрес или множество адреси разделени с ; към, които ще се изпраща съобщението

__host__ (Задължително) Име на host

__port__ (Задължително) Номер на port

От съответния конфигурационен файл, в който се използва плъгина трябва да се посочат стойности на задължителните полета н.р.

	sendEmail {
	    message = "Your code has been checked."
		subject = "Results"
		toAddress = "person123456@gmail.com;person9876@gmail.com"
		host = "smtp.gmail.com"
		port = "587"
	}


### Документация

Документацията на системата служи за подпомагане и улесняване на потребителите използващи системата. За да бъде генерирана 
не е необходимо да се посочват никакви други допълнителни конфигурационни файлове или системни свойства __system property__.
Генериране на документацията по време изпълнението се осъществява чрез изпълняването на командата

	./gradlew baseHtml

След успешно генериране ще се изведе следния изход:

	:copyStyles
	:concatPartsMd
	:rawHtml
	:baseHtml
	 Documentation is generated in:
	/Project/build/html/baseHtml.html

След това тя ще може да бъде достъпена при отвяряне на baseHtml.html файла.
#### Начин на генериране на документацията
Документацията се състои от инфромация, която описва различни системни функционалности и как те да бъдат конфигурирани и настройвани.
Всичката тази информация трябва да бъде въведена в текстов вид. Това става чрез описанието й в [markdown](http://daringfireball.net/projects/markdown/) формат и съхраняването и в 
	
	project/src/main/parts/number-description.md
	
където __number__ е последователен номер, показващ къде дадения markdown файл ще се разположи, __description__ е значещо име описващо съдържанието 
на файла. 
Всички файлове с разширение __md__ се обединяват в един общ файл __parts.md__, който се разполага в __buildDir/parts.md__, където
__buildDir__ е името на специфицираната билд директория за проекта.
След като бъдат обединени файловете по лексикографски ред в един общ файл от тях се извършват преобрзования и се генерира изходния __BaseHtml.html__
Освен това при генерирането се извършва и копиране на css файловете и необходимите шрифтове за документацията. Тяхното първоначално местонахождение е
в 

	project/src/style
	
Начинът, по който се извършва трансформацията от _md_ файл в _html_ е описана в 

	project/src/main/transforms/base.groovy
	
Цялата логика и стъпките на извършване на генериране на документацията са разположени в
	
	project/config/docs.gradle

Част от функционалностите за генериране и преобразуване, са изведени в самостоятелни приставки, които може да бъдат преизползвани. Това са намиращите 
се в _buildSrc_ разширения - _jsoup_, _pegdown_, _xhtmlrenderer_.
	




